version: '3.8'

services:
    broker:
        build:
            context: ../src
            dockerfile: TFM.Broker/Dockerfile
        container_name: tfm-broker
        restart: unless-stopped

        ports:
            - "127.0.0.1:5000:5000"
            - "50051:50051"

        volumes:
            - ../../certs:/app/certs:ro
            - ../../config:/app/config:ro
            - ./logs:/app/logs

        environment:
            - ASPNETCORE_ENVIRONMENT=Production
            - Certificates__BrokerCertPassword=${BROKER_CERT_PASSWORD}
            - Security__AdminApiKey=${ADMIN_API_KEY}

        networks:
            - broker-net

        # Seguridad
        security_opt:
            - no-new-privileges:true
        cap_drop:
            - ALL
        cap_add:
            - NET_BIND_SERVICE # Para puerto 50051

        healthcheck:
            test: [ "CMD", "curl", "-f", "http://localhost:5000/health" ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 20s

networks:
    broker-net:
        driver: bridge
