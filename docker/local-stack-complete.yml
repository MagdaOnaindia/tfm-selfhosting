version: '3.8'

services:
  # --- Traefik: Reverse Proxy Local ---
  traefik:
    image: traefik:v2.10
    container_name: selfhosting-traefik
    restart: unless-stopped
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /opt/selfhosting/traefik/dynamic:/etc/traefik/dynamic
    networks:
      - selfhosting-net

  # --- Agent: El cliente que conecta con el Broker ---
  agent:
    build:
      context: ../src/TFM.Agent  # El contexto es la carpeta del proyecto del Agente
      dockerfile: Dockerfile     # El Dockerfile está DENTRO de esa carpeta de contexto
    container_name: selfhosting-agent
    restart: unless-stopped
    volumes:
      - /opt/selfhosting/certs:/opt/selfhosting/certs:ro
      - /opt/selfhosting/config:/opt/selfhosting/config:ro
    environment:
      - DOTNET_ENVIRONMENT=Production
      - AGENT_CERT_PASSWORD=${CERT_PASSWORD}
    networks:
      - selfhosting-net
    depends_on:
      - traefik

  # --- Dashboard: La interfaz web de gestión ---
  dashboard:
    build:
      context: ../src/TFM.Dashboard # El contexto es la carpeta del proyecto del Dashboard
      dockerfile: Dockerfile     # El Dockerfile está DENTRO de esa carpeta de contexto
    container_name: selfhosting-dashboard
    restart: unless-stopped
    ports:
      - "5500:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /opt/selfhosting/data:/app/data
      - /opt/selfhosting/apps:/app/apps
      - /opt/selfhosting/traefik/dynamic:/app/traefik/dynamic
    networks:
      - selfhosting-net

networks:
  selfhosting-net:
    driver: bridge
