---
- name: Setup SelfHosting Local System Environment
  hosts: localhost
  connection: local
  become: yes # Indica que las tareas se ejecutar√°n con privilegios de superusuario (sudo)

  vars:
    # Variable para el usuario principal, pasada desde el script de shell
    # El valor por defecto es 'selfhost' por si no se pasa
    ansible_user: "{{ ansible_user | default('selfhost') }}"
    base_path: /opt/selfhosting

  tasks:
    - name: Create required directory structure
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'
      loop:
        - "{{ base_path }}"
        - "{{ base_path }}/certs"
        - "{{ base_path }}/config"
        - "{{ base_path }}/apps"
        - "{{ base_path }}/data"
        - "{{ base_path }}/traefik/dynamic"
        - "{{ base_path }}/logs"

    - name: Configure UFW to allow local services
      community.general.ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: tcp
        comment: "{{ item.comment }}"
      loop:
        - { port: '80', comment: 'Allow Traefik HTTP' }
        - { port: '5500', comment: 'Allow Dashboard Access' }
